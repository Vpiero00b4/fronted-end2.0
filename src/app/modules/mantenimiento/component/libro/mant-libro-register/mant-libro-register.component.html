<!-- Modal Bootstrap 5 Mejorado -->
<div class="modal d-block fade show" tabindex="-1" role="dialog" aria-modal="true"
  style="background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1050;"
  (click)="onOverlayClick($event)">
  <div class="modal-dialog modal-xl modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content border-0 shadow-lg">

      <!-- Header del Modal -->
      <div class="modal-header bg-primary text-white border-0 py-3">
        <h2 class="modal-title h4 mb-0 d-flex align-items-center">
          <i class="fas fa-book me-2"></i>
          {{ isEditMode ? 'Actualizar Libro' : 'Crear Nuevo Libro' }}
        </h2>
        <button type="button" class="btn-close btn-close-white" (click)="onClose()"></button>
      </div>

      <div class="modal-body p-4">
        <!-- Alertas mejoradas -->
        <div *ngIf="showSuccessAlert" class="alert alert-success border-0 shadow-sm d-flex align-items-center mb-4">
          <div class="alert-icon me-3">
            <i class="fas fa-check-circle fs-4 text-success"></i>
          </div>
          <div class="flex-grow-1">
            <strong>¡Éxito!</strong>
            <div>{{ successMessage }}</div>
          </div>
        </div>

        <div *ngIf="showErrorAlert" class="alert alert-danger border-0 shadow-sm d-flex align-items-center mb-4">
          <div class="alert-icon me-3">
            <i class="fas fa-exclamation-triangle fs-4 text-danger"></i>
          </div>
          <div class="flex-grow-1">
            <strong>¡Error!</strong>
            <div>{{ errorMessage }}</div>
          </div>
        </div>

        <form (ngSubmit)="onSubmit()" #libroForm="ngForm">

          <!-- Sección: Información Básica -->
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-info-circle text-primary me-2"></i>
              Información Básica
            </h5>
            <div class="row g-3">
              <!-- Título -->
              <div class="col-md-6">
                <label for="titulo" class="form-label fw-semibold">
                  <i class="fas fa-heading text-muted me-1"></i>
                  Título *
                </label>
                <input type="text" class="form-control form-control-modern" id="titulo" name="titulo"
                  [(ngModel)]="libro.titulo" required placeholder="Ingrese el título del libro" />
              </div>

              <!-- ISBN -->
              <div class="col-md-6">
                <label for="isbn" class="form-label fw-semibold">
                  <i class="fas fa-barcode text-muted me-1"></i>
                  ISBN
                </label>
                <input type="text" class="form-control form-control-modern" id="isbn" name="isbn"
                  [(ngModel)]="libro.isbn" placeholder="Ej: 978-3-16-148410-0" />
              </div>

              <!-- Tamaño -->
              <div class="col-md-6">
                <label for="tamanno" class="form-label fw-semibold">
                  <i class="fas fa-ruler text-muted me-1"></i>
                  Tamaño
                </label>
                <input type="text" class="form-control form-control-modern" id="tamanno" name="tamanno"
                  [(ngModel)]="libro.tamanno" placeholder="Ej: 15x21 cm" />
              </div>

              <!-- Autor con búsqueda -->
              <div class="col-md-6 position-relative">
                <label for="buscarAutor" class="form-label fw-semibold">
                  <i class="fas fa-user-edit text-muted me-1"></i>
                  Autor
                </label>
                <div class="input-group">
                  <input type="text" id="buscarAutor" class="form-control form-control-modern"
                    placeholder="Buscar autor..." [(ngModel)]="buscarAutor" [ngModelOptions]="{standalone: true}" />
                  <button type="button" class="btn btn-outline-primary" (click)="buscarAutores()">
                    <i class="fas fa-search"></i>
                  </button>
                </div>

                <!-- Dropdown de autores -->
                <div *ngIf="autoresFiltrados.length > 0" class="dropdown-results">
                  <ul class="list-group shadow-sm">
                    <li *ngFor="let autor of autoresFiltrados" (click)="seleccionarAutor(autor)"
                      class="list-group-item list-group-item-action d-flex align-items-center">
                      <i class="fas fa-user-circle text-primary me-2"></i>
                      {{ autor.nombre }} {{ autor.apellido }}
                    </li>
                  </ul>
                </div>

                <div *ngIf="autoresFiltrados.length === 0 && buscarAutor.trim().length > 0 && mostrarMensaje"
                  class="text-muted small mt-1">
                  <i class="fas fa-info-circle me-1"></i>
                  No se encontraron resultados.
                </div>

                <button *ngIf="autoresFiltrados.length === 0 && buscarAutor.trim().length > 0 && mostrarMensaje"
                  type="button" (click)="abrirCrearAutorModal()" class="btn btn-success btn-sm mt-2">
                  <i class="fas fa-plus me-1"></i>
                  Crear Autor
                </button>
              </div>
            </div>
          </div>

          <!-- Modal Crear Autor -->
          <app-autor *ngIf="mostrarModalCrearAutor" (autorCreado)="recibirAutorCreado($event)"
            (cerrarModal)="cerrarCrearAutorModal()"></app-autor>

          <!-- Sección: Descripción -->
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-align-left text-primary me-2"></i>
              Descripción
            </h5>
            <div class="col-12">
              <textarea class="form-control form-control-modern" id="descripcion" name="descripcion" rows="3"
                [(ngModel)]="libro.descripcion" placeholder="Descripción detallada del libro..."></textarea>
            </div>
          </div>

          <!-- Sección: Características -->
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-cogs text-primary me-2"></i>
              Características
            </h5>
            <div class="row g-3">
              <!-- Condición -->
              <div class="col-md-6">
                <label for="condicion" class="form-label fw-semibold">
                  <i class="fas fa-star text-muted me-1"></i>
                  Condición
                </label>
                <input type="text" class="form-control form-control-modern" id="condicion" name="condicion"
                  [(ngModel)]="libro.condicion" placeholder="Ej: Nuevo, Usado, Como nuevo" />
              </div>

              <!-- Impresión -->
              <div class="col-md-6">
                <label for="impresion" class="form-label fw-semibold">
                  <i class="fas fa-print text-muted me-1"></i>
                  Impresión
                </label>
                <input type="text" class="form-control form-control-modern" id="impresion" name="impresion"
                  [(ngModel)]="libro.impresion" placeholder="Ej: Primera edición, Reimpresión" />
              </div>

              <!-- Tipo de Tapa -->
              <div class="col-md-6">
                <label for="tipoTapa" class="form-label fw-semibold">
                  <i class="fas fa-book text-muted me-1"></i>
                  Tipo de Tapa
                </label>
                <input type="text" class="form-control form-control-modern" id="tipoTapa" name="tipoTapa"
                  [(ngModel)]="libro.tipoTapa" placeholder="Ej: Tapa dura, Tapa blanda" />
              </div>

              <!-- Estado (Checkbox mejorado) -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">
                  <i class="fas fa-toggle-on text-muted me-1"></i>
                  Estado
                </label>
                <div class="toggle-container">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="estado" name="estado"
                      [(ngModel)]="libro.estado" />
                    <label class="form-check-label fw-semibold" for="estado">
                      Libro Activo
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección: Categorización -->
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-tags text-primary me-2"></i>
              Categorización
            </h5>
            <div class="row g-3">
              <!-- Subcategoría -->
              <div class="col-md-4">
                <label for="idSubcategoria" class="form-label fw-semibold">
                  <i class="fas fa-bookmark text-muted me-1"></i>
                  Subcategoría *
                </label>
                <select class="form-select form-control-modern" id="idSubcategoria" name="idSubcategoria"
                  [(ngModel)]="libro.idSubcategoria" required>
                  <option value="" disabled>Seleccione subcategoría</option>
                  <option *ngFor="let sub of subCategoria" [value]="sub.id">{{ sub.descripcion }}</option>
                </select>
              </div>

              <!-- Tipo de Papel -->
              <div class="col-md-4">
                <label for="idTipoPapel" class="form-label fw-semibold">
                  <i class="fas fa-file-alt text-muted me-1"></i>
                  Tipo de Papel *
                </label>
                <select class="form-select form-control-modern" id="idTipoPapel" name="idTipoPapel"
                  [(ngModel)]="libro.idTipoPapel" required>
                  <option value="" disabled>Seleccione tipo de papel</option>
                  <option *ngFor="let tipo of tiposPapel" [value]="tipo.idTipoPapel">{{ tipo.descripcion }}</option>
                </select>
              </div>

              <!-- Proveedor -->
              <div class="col-md-4">
                <label for="idProveedor" class="form-label fw-semibold">
                  <i class="fas fa-building text-muted me-1"></i>
                  Proveedor *
                </label>
                <select class="form-select form-control-modern" id="idProveedor" name="idProveedor"
                  [(ngModel)]="libro.idProveedor" required>
                  <option value="" disabled>Seleccione proveedor</option>
                  <option *ngFor="let prov of provedor" [value]="prov.idProveedor">{{ prov.razonSocial }}</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Sección: Precio y Stock -->
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-dollar-sign text-primary me-2"></i>
              Precio y Stock
            </h5>
            <div class="row g-3">
              <!-- Precio -->
              <div class="col-md-6">
                <label for="precioVenta" class="form-label fw-semibold">
                  <i class="fas fa-tag text-muted me-1"></i>
                  Precio de Venta *
                </label>
                <div class="input-group">
                  <span class="input-group-text bg-light">S/</span>
                  <input type="number" class="form-control form-control-modern" id="precioVenta" name="precioVenta"
                    [(ngModel)]="precioVenta" required placeholder="0.00" step="0.01" />
                </div>
              </div>

              <!-- Stock -->
              <div class="col-md-6">
                <label for="Stock" class="form-label fw-semibold">
                  <i class="fas fa-boxes text-muted me-1"></i>
                  Stock *
                </label>
                <input type="number" class="form-control form-control-modern" id="Stock" name="Stock"
                  [(ngModel)]="Stock" required placeholder="0" min="0" />
              </div>
            </div>
          </div>

          <!-- Sección: Imagen -->
          <div class="form-section mb-4">
            <h5 class="section-title">
              <i class="fas fa-image text-primary me-2"></i>
              Imagen del Libro
            </h5>

            <!-- Imagen Previsualizada -->
            <div *ngIf="imageUrl" class="text-center mb-3">
              <div class="image-preview-container">
                <img [src]="imageUrl" alt="Previsualización" class="image-preview" />
                <button (click)="removeImage()" type="button" class="btn-remove-image" title="Eliminar imagen">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <!-- Subir imagen -->
            <div class="upload-area" [class.has-image]="imageUrl">
              <input class="form-control" type="file" id="imagen" name="imagen" (change)="onImageSelected($event)"
                accept="image/*" hidden #fileInput />
              <label for="imagen" class="upload-label" (click)="fileInput.click()">
                <i class="fas fa-cloud-upload-alt fs-2 text-primary mb-2"></i>
                <div class="fw-semibold">Seleccionar imagen</div>
                <small class="text-muted">PNG, JPG hasta 5MB</small>
              </label>
            </div>
          </div>

        </form>
      </div>

      <!-- Footer del Modal -->
      <div class="modal-footer bg-light border-0 py-3">
        <button type="button" (click)="onClose()" class="btn btn-outline-secondary px-4">
          <i class="fas fa-times me-1"></i>
          Cancelar
        </button>
        <button type="submit" (click)="onSubmit()" class="btn btn-primary px-4">
          <i class="fas fa-save me-1"></i>
          {{ isEditMode ? 'Actualizar Libro' : 'Crear Libro' }}
        </button>
      </div>

    </div>
  </div>
</div>